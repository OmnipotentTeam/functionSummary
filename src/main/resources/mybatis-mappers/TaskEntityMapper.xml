<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhxx.service.szxt.mapper.TaskEntityMapper">
  <resultMap id="BaseResultMap" type="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="task_id" jdbcType="VARCHAR" property="taskId" />
    <result column="task_name" jdbcType="VARCHAR" property="taskName" />
    <result column="dimension_name" jdbcType="VARCHAR" property="dimensionName" />
    <result column="dimension_id" jdbcType="VARCHAR" property="dimensionId" />
    <result column="task_stop_time" jdbcType="DATE" property="taskStopTime" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="task_status" jdbcType="INTEGER" property="taskStatus" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
    <result column="status" jdbcType="INTEGER" property="status" />
    <result column="stageall" jdbcType="INTEGER" property="stageAll" />
    <result column="username" jdbcType="VARCHAR" property="userName" />

  </resultMap>

  <resultMap id="TaskResultMap" type="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="task_id" jdbcType="VARCHAR" property="taskId" />
    <result column="task_name" jdbcType="VARCHAR" property="taskName" />
    <result column="dimension_name" jdbcType="VARCHAR" property="dimensionName" />
    <result column="dimension_id" jdbcType="VARCHAR" property="dimensionId" />
    <result column="task_stop_time" jdbcType="DATE" property="taskStopTime" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="task_status" jdbcType="INTEGER" property="taskStatus" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
    <result column="status" jdbcType="INTEGER" property="status" />

    <collection property="stageEntityList" ofType="com.zhxx.service.szxt.entity.StageEntity" javaType="java.util.List">

      <id column="stageid" jdbcType="VARCHAR" property="stageId" />
      <result column="taskid" jdbcType="VARCHAR" property="taskId" />
      <result column="stagenum" jdbcType="INTEGER" property="stageNum" />
      <result column="stagestoptime" jdbcType="DATE" property="stageStopTime" />
      <result column="stagecontent" jdbcType="VARCHAR" property="stageContent" />
      <result column="createtime" jdbcType="TIMESTAMP" property="createTime" />
      <result column="modifytime" jdbcType="TIMESTAMP" property="modifyTime" />
      <result column="statu" jdbcType="INTEGER" property="status" />
    </collection>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    task_id, task_name, dimension_id, task_stop_time, user_id, task_status, create_time, 
    modify_time, status
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from task
    where task_id = #{taskId,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from task
    where task_id = #{taskId,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into task (task_id, task_name, dimension_id, 
      task_stop_time, user_id, task_status, 
      create_time, modify_time, status
      )
    values (#{taskId,jdbcType=VARCHAR}, #{taskName,jdbcType=VARCHAR}, #{dimensionId,jdbcType=VARCHAR}, 
      #{taskStopTime,jdbcType=DATE}, #{userId,jdbcType=INTEGER}, #{taskStatus,jdbcType=INTEGER}, 
      #{createTime,jdbcType=TIMESTAMP}, #{modifyTime,jdbcType=TIMESTAMP}, #{status,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into task
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="taskId != null">
        task_id,
      </if>
      <if test="taskName != null">
        task_name,
      </if>
      <if test="dimensionId != null">
        dimension_id,
      </if>
      <if test="taskStopTime != null">
        task_stop_time,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="taskStatus != null">
        task_status,
      </if>
      <if test="createTime != null">
        create_time,
      </if>
      <if test="modifyTime != null">
        modify_time,
      </if>
      <if test="status != null">
        status,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="taskId != null">
        #{taskId,jdbcType=VARCHAR},
      </if>
      <if test="taskName != null">
        #{taskName,jdbcType=VARCHAR},
      </if>
      <if test="dimensionId != null">
        #{dimensionId,jdbcType=VARCHAR},
      </if>
      <if test="taskStopTime != null">
        #{taskStopTime,jdbcType=DATE},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="taskStatus != null">
        #{taskStatus,jdbcType=INTEGER},
      </if>
      <if test="createTime != null">
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifyTime != null">
        #{modifyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        #{status,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update task
    <set>
      <if test="taskName != null">
        task_name = #{taskName,jdbcType=VARCHAR},
      </if>
      <if test="dimensionId != null">
        dimension_id = #{dimensionId,jdbcType=VARCHAR},
      </if>
      <if test="taskStopTime != null">
        task_stop_time = #{taskStopTime,jdbcType=DATE},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="taskStatus != null">
        task_status = #{taskStatus,jdbcType=INTEGER},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifyTime != null">
        modify_time = #{modifyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="status != null">
        status = #{status,jdbcType=INTEGER},
      </if>
    </set>
    where task_id = #{taskId,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update task
    set task_name = #{taskName,jdbcType=VARCHAR},
      dimension_id = #{dimensionId,jdbcType=VARCHAR},
      task_stop_time = #{taskStopTime,jdbcType=DATE},
      user_id = #{userId,jdbcType=INTEGER},
      task_status = #{taskStatus,jdbcType=INTEGER},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      modify_time = #{modifyTime,jdbcType=TIMESTAMP},
      status = #{status,jdbcType=INTEGER}
    where task_id = #{taskId,jdbcType=VARCHAR}
  </update>

  <select id="selectTaskList" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    task.* ,dimension.dimension_name,count(*) stageall,sys_user.username username
    from task,dimension,stage,sys_user
    where   task.dimension_id = #{dimensionId,jdbcType=VARCHAR}
    AND task.dimension_id=dimension.dimension_id
    AND  task.task_stop_time > Now()
    AND  task.`status`=1
    AND task.task_status=1
    AND task.task_id=stage.task_id
    AND task.user_id=sys_user.id
    GROUP BY task.task_id
  </select>

  <select id="selectUnpublishedTask"  parameterType="com.zhxx.service.szxt.entity.TaskEntity" resultMap="TaskResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select task.task_id, task.task_name,task.dimension_id,task.task_stop_time,task.user_id,task.task_status,task.create_time,task.modify_time,stage.stage_id stageid,
    stage.task_id taskid,stage.stage_num stagenum,stage.stage_stop_time stagestoptime,stage.stage_content stagecontent,stage.create_time createtime,stage.modify_time modifytime,stage.`status` statu
    from task
    LEFT JOIN stage ON task.task_id = stage.task_id
    WHERE task.status = 1
    AND stage.stage_num !=100
    <if test="taskName != null">
    and  task_name LIKE CONCAT('%', #{taskName}, '%')
    </if>
    <if test="dimensionId != null">
    and dimension_id = #{dimensionId,jdbcType=INTEGER}
    </if>
    <if test="userId != null">
    and user_id = #{userId,jdbcType=INTEGER}
    </if>
    <if test="state == 0">
    and task_status = 0
    </if>
    <if test="state == 1">
    and task_stop_time > NOW() and task_status = 1
    </if>
    <if test="state ==2">
    and NOW() > task_stop_time and task_status = 1
    </if>
    ORDER BY task.task_id
  </select>
  <select id="selectUpTask"  parameterType="com.zhxx.service.szxt.entity.TaskEntity" resultMap="TaskResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select *
    from task
    WHERE task.status = 1
    <if test="taskName != null">
      and  task_name LIKE CONCAT('%', #{taskName}, '%')
    </if>
    <if test="dimensionId != null">
      and dimension_id = #{dimensionId,jdbcType=INTEGER}
    </if>
    <if test="userId != null">
      and user_id = #{userId,jdbcType=INTEGER}
    </if>
    <if test="state == 0">
      and task_status = 0
    </if>
    <if test="state == 1">
      and task_stop_time > NOW() and task_status = 1
    </if>
    <if test="state ==2">
      and NOW() > task_stop_time and task_status = 1
    </if>
    ORDER BY task.create_time DESC
  </select>
  <update id="deleteUnpublishedTask" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update task
    set status = 0
    where task_id = #{taskId,jdbcType=VARCHAR}
  </update>
  <update id="updateUnpublishedTask" parameterType="com.zhxx.service.szxt.entity.TaskEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update task
    set
    task_status = 1
    where task_id = #{taskId,jdbcType=VARCHAR}
  </update>
  <select id="selectPcTask" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    task.* ,dimension.dimension_name,count(*) stageall
    from task,dimension,stage
    where   task.task_id = #{taskId,jdbcType=VARCHAR}
    AND task.dimension_id=dimension.dimension_id
    AND  task.`status`=1
    AND task.task_status=1
    AND task.task_id=stage.task_id
    GROUP BY task.task_id
  </select>
  <select id="selectPcTaskCount" parameterType="java.lang.String" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    task.* ,dimension.dimension_name,count(*) stageall
    from task,dimension,stage
    where   task.task_id = #{taskId,jdbcType=VARCHAR}
    AND task.dimension_id=dimension.dimension_id
    AND task.task_status=1
    AND task.task_id=stage.task_id
    GROUP BY task.task_id
  </select>
</mapper>